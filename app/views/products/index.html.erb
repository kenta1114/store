<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="display-4">商品一覧</h1>
  <% if authenticated? %>
    <%= link_to "新商品追加", new_product_path, class: "btn btn-primary" %>
  <% end %>
</div>

<!-- Search and Filter Bar -->
<div class="row mb-4">
  <div class="col-md-6">
    <%= form_with url: products_path, method: :get, local: true, class: "d-flex" do |form| %>
      <%= form.text_field :search, 
          value: params[:search], 
          placeholder: "商品名や説明で検索...", 
          class: "form-control me-2" %>
      <%= form.submit "検索", class: "btn btn-outline-primary" %>
    <% end %>
  </div>
  
  <div class="col-md-3">
    <%= form_with url: products_path, method: :get, local: true, class: "d-flex" do |form| %>
      <%= form.hidden_field :search, value: params[:search] %>
      <%= form.select :category, 
          options_for_select([['全カテゴリ', '']] + @categories.map { |c| [c, c] }, params[:category]),
          {}, 
          { class: "form-select", onchange: "this.form.submit();" } %>
    <% end %>
  </div>
  
  <div class="col-md-3">
    <%= form_with url: products_path, method: :get, local: true, class: "d-flex" do |form| %>
      <%= form.hidden_field :search, value: params[:search] %>
      <%= form.hidden_field :category, value: params[:category] %>
      <%= form.select :sort,
          options_for_select([
            ['新着順', ''],
            ['価格: 安い順', 'price_asc'],
            ['価格: 高い順', 'price_desc'],
            ['名前順', 'name_asc']
          ], params[:sort]),
          {},
          { class: "form-select", onchange: "this.form.submit();" } %>
    <% end %>
  </div>
</div>

<!-- Products Grid -->
<div class="row">
  <% if @products.any? %>
    <% @products.each do |product| %>
      <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
        <div class="card h-100 shadow-sm">
          <div class="position-relative">
            <% if product.featured_image.attached? %>
              <%= image_tag product.featured_image, class: "card-img-top", style: "height: 200px; object-fit: cover;" %>
            <% else %>
              <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                <i class="fas fa-image text-muted fa-3x"></i>
              </div>
            <% end %>
            
            <% if product.inventory_count == 0 %>
              <div class="position-absolute top-0 end-0 m-2">
                <span class="badge bg-danger">売切れ</span>
              </div>
            <% elsif product.inventory_count < 5 %>
              <div class="position-absolute top-0 end-0 m-2">
                <span class="badge bg-warning text-dark">残り<%= product.inventory_count %>個</span>
              </div>
            <% end %>
          </div>
          
          <div class="card-body d-flex flex-column">
            <h5 class="card-title"><%= product.name %></h5>
            
            <% if product.category.present? %>
              <p class="text-muted mb-2">
                <small><i class="fas fa-tag"></i> <%= product.category %></small>
              </p>
            <% end %>
            
            <p class="card-text flex-grow-1">
              <%= truncate(strip_tags(product.description), length: 80) %>
            </p>
            
            <div class="mt-auto">
              <% if product.price.present? %>
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="h5 mb-0 text-primary">¥<%= number_with_delimiter(product.price.to_i) %></span>
                  <small class="text-muted">在庫: <%= product.inventory_count %>個</small>
                </div>
              <% end %>
              
              <div class="d-grid gap-2">
                <%= link_to product_path(product), class: "btn btn-outline-primary" do %>
                  <i class="fas fa-eye"></i> 詳細を見る
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="col-12 text-center">
      <div class="py-5">
        <i class="fas fa-search fa-3x text-muted mb-3"></i>
        <h3 class="text-muted">商品が見つかりませんでした</h3>
        <p class="text-muted">検索条件を変更してお試しください。</p>
        <%= link_to "全ての商品を見る", products_path, class: "btn btn-primary" %>
      </div>
    </div>
  <% end %>
</div>
